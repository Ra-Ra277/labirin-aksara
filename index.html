<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Labirin Aksara: Menyusun Jejak, Menjaga Tradisi</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+Javanese&family=Noto+Sans+Balinese&family=Noto+Sans+Buginese&display=swap');

        :root {
            --bg-jawa: #4a3c31;
            --bg-bali: #2d5a27;
            --bg-sulsel: #1a3c5a;
            --ui-gold: #ffd700;
            --ui-brown: #5c4033;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #111;
            font-family: 'Press Start 2P', cursive;
            color: white;
            overflow: hidden;
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16/9;
            background: #000;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        /* UI Overlay */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            box-sizing: border-box;
        }

        .hud-top {
            display: flex;
            justify-content: space-between;
            text-shadow: 2px 2px 0 #000;
        }

        .lives {
            color: #ff4444;
        }

        /* Screens */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            pointer-events: auto;
            z-index: 10;
        }

        .hidden { display: none !important; }

        h1 { font-size: 24px; color: var(--ui-gold); margin-bottom: 10px; line-height: 1.5; }
        h2 { font-size: 16px; color: #fff; margin-bottom: 20px; }
        p { font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6; max-width: 80%; margin: 10px auto; }

        button {
            background: var(--ui-brown);
            color: var(--ui-gold);
            border: 4px solid var(--ui-gold);
            padding: 15px 30px;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }

        /* Puzzle Interface */
        #puzzle-interface {
            background: rgba(40, 30, 20, 0.95);
            border: 4px solid var(--ui-gold);
            padding: 20px;
            width: 80%;
            max-width: 500px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            flex-direction: column;
            align-items: center;
            pointer-events: auto;
        }

        .puzzle-word {
            font-size: 20px;
            color: #fff;
            margin: 15px 0;
        }

        .aksara-slots {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            min-height: 40px;
        }

        .slot {
            width: 50px;
            height: 50px;
            border: 2px dashed #888;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: rgba(0,0,0,0.3);
        }

        .aksara-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 15px;
        }

        .aksara-btn {
            width: 60px;
            height: 60px;
            background: #ffe4b5;
            color: #000;
            border: 4px solid #8b4513;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
        }
        .aksara-btn span { font-size: 10px; margin-top: 4px; font-family: sans-serif; opacity: 0.7; }

        /* Mobile Controls */
        #mobile-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            height: 100px;
            pointer-events: none;
            display: none; /* Shown via JS on touch */
            justify-content: space-between;
            padding: 0 40px;
            box-sizing: border-box;
        }

        .control-btn {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: white;
            user-select: none;
        }
        
        .aksara-font-jawa { font-family: 'Noto Sans Javanese', sans-serif; }
        .aksara-font-bali { font-family: 'Noto Sans Balinese', sans-serif; }
        .aksara-font-sulsel { font-family: 'Noto Sans Buginese', sans-serif; }

        /* Library Styles */
        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            width: 100%;
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
        }
        .lib-card {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border: 1px solid var(--ui-gold);
            text-align: left;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas" width="800" height="450"></canvas>
    
    <!-- HUD -->
    <div id="ui-layer">
        <div class="hud-top">
            <div id="score-display">LEVEL: 1 - JAWA</div>
            <div id="lives-display" class="lives">❤❤❤</div>
        </div>
        
        <!-- Mobile Controls (Visible on touch devices) -->
        <div id="mobile-controls">
            <div class="d-pad">
                <div class="control-btn" id="btn-left">←</div>
                <div class="control-btn" id="btn-right" style="position:absolute; left: 120px; bottom: 0;">→</div>
            </div>
            <div class="action-btn">
                <div class="control-btn" id="btn-jump">JMP</div>
            </div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen" class="screen">
        <h1>LABIRIN AKSARA</h1>
        <p>Menyusun Jejak, Menjaga Tradisi</p>
        <br>
        <div style="font-size: 10px; color: #aaa;">
            Petunjuk:<br>
            [Panah/A,D] Gerak | [Spasi/W] Lompat<br>
            Kumpulkan gulungan & buka Gerbang Aksara.
        </div>
        <button onclick="startGame()">MULAI PETUALANGAN</button>
    </div>

    <!-- Puzzle Interface -->
    <div id="puzzle-interface">
        <h2 style="color:var(--ui-gold);">GERBANG AKSARA</h2>
        <p>Terjemahkan kata ini:</p>
        <div class="puzzle-word" id="puzzle-question">MAKAN</div>
        
        <div class="aksara-slots" id="puzzle-slots"></div>
        <div class="aksara-options" id="puzzle-options"></div>
        
        <p id="puzzle-feedback" style="height: 20px; color: #ffeb3b;"></p>
        <button onclick="checkPuzzle()" style="padding: 10px 20px; margin-top:10px;">BUKA GERBANG</button>
    </div>

    <!-- Level Complete / Next Level -->
    <div id="level-screen" class="screen hidden">
        <h1 id="level-title">LEVEL SELESAI</h1>
        <p id="level-desc">Gerbang terbuka!</p>
        <button onclick="nextLevel()">LANJUTKAN</button>
    </div>

    <!-- Game Over -->
    <div id="gameover-screen" class="screen hidden">
        <h1 style="color:red;">OBOR PADAM</h1>
        <p>Jangan menyerah untuk belajar.</p>
        <button onclick="location.reload()">COBA LAGI</button>
    </div>

    <!-- Victory / Pustaka Budaya -->
    <div id="victory-screen" class="screen hidden">
        <h1 style="color: var(--ui-gold);">PUSTAKA BUDAYA</h1>
        <p>"Warisan ini tidak punah selama kita masih mengejanya."</p>
        <div class="library-grid" id="library-content">
            <!-- Populated by JS -->
        </div>
        <button onclick="location.reload()">KEMBALI KE MENU</button>
    </div>
</div>

<script>
/**
 * AUDIO ENGINE (Simple Synth)
 */
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();

function playSound(type) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    
    osc.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    
    if (type === 'jump') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
    } else if (type === 'collect') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(600, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.2);
    } else if (type === 'gate_open') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(220, audioCtx.currentTime);
        // Gamelan-ish gong effect
        osc.frequency.exponentialRampToValueAtTime(220, audioCtx.currentTime + 1);
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.5);
        osc.start();
        osc.stop(audioCtx.currentTime + 1.5);
    } else if (type === 'error') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(100, audioCtx.currentTime);
        osc.frequency.linearRampToValueAtTime(50, audioCtx.currentTime + 0.3);
        gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.3);
    }
}

/**
 * GAME DATA & ASSETS
 */
const LEVELS = [
    {
        id: 1,
        name: "Jawa (Mataraman)",
        bg: "#5D4037", // Wood brown
        fg: "#3E2723",
        accent: "#4CAF50", // Forest
        fontClass: "aksara-font-jawa",
        word: { id: "SEGA", text: "SEGA (Nasi)", script: ["ꦱꦼ", "ꦒ"], roman: ["Se", "Ga"] }
    },
    {
        id: 2,
        name: "Bali (Dewata)",
        bg: "#1B5E20", // Moss green
        fg: "#33691E",
        accent: "#FBC02D", // Temple stone/Gold
        fontClass: "aksara-font-bali",
        word: { id: "TIRTA", text: "TIRTA (Air)", script: ["ᬢᬶ", "ᬃ", "ᬢ"], roman: ["Ti", "r", "ta"] }
    },
    {
        id: 3,
        name: "Sulsel (Anging Mammiri)",
        bg: "#0277BD", // Sea/Sky
        fg: "#01579B",
        accent: "#BDBDBD", // Karst rocks
        fontClass: "aksara-font-sulsel",
        word: { id: "BULU", text: "BULU (Gunung)", script: ["ᨅᨗ", "ᨒᨗ"], roman: ["Bu", "lu"] }
    }
];

const DICTIONARY = [
    { region: "Jawa", word: "Sega", mean: "Nasi", script: "ꦱꦼꦒ", desc: "Makanan pokok masyarakat agraris." },
    { region: "Jawa", word: "Omah", mean: "Rumah", script: "ꦲꦺꦴꦩah", desc: "Tempat bernaung dan berkumpul keluarga." },
    { region: "Bali", word: "Tirta", mean: "Air Suci", script: "ᬢᬶᬃᬢ", desc: "Air yang digunakan dalam upacara penyucian." },
    { region: "Bali", word: "Rahajeng", mean: "Selamat", script: "ᬭᬳᬚᭂᬂ", desc: "Ucapan doa keselamatan." },
    { region: "Sulsel", word: "Bulu", mean: "Gunung", script: "ᨅᨗᨒᨗ", desc: "Simbol kekokohan dan ketinggian." },
    { region: "Sulsel", word: "Siri'", mean: "Harga Diri", script: "ᨔᨗᨑᨗ", desc: "Falsafah hidup menjaga kehormatan." }
];

/**
 * GAME ENGINE
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let gameState = 'MENU'; // MENU, PLAYING, PUZZLE, TRANSITION, GAMEOVER, VICTORY
let currentLevelIdx = 0;
let lives = 3;
let cameraX = 0;
let frame = 0;

// Input State
const keys = { right: false, left: false, up: false };

// Touch controls logic
if('ontouchstart' in window) {
    document.getElementById('mobile-controls').style.display = 'flex';
    
    const bindTouch = (id, key) => {
        const btn = document.getElementById(id);
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
        btn.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
    };
    bindTouch('btn-left', 'left');
    bindTouch('btn-right', 'right');
    bindTouch('btn-jump', 'up');
}

window.addEventListener('keydown', e => {
    if(e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = true;
    if(e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = true;
    if(e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') keys.up = true;
});

window.addEventListener('keyup', e => {
    if(e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = false;
    if(e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = false;
    if(e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') keys.up = false;
});

// Entities
class Player {
    constructor() {
        this.x = 100;
        this.y = 200;
        this.w = 20;
        this.h = 32;
        this.vx = 0;
        this.vy = 0;
        this.speed = 4;
        this.jumpPower = -10; // slightly floaty
        this.grounded = false;
        this.facingRight = true;
        this.color = "#FF9800"; // Arka's shirt
    }

    update() {
        // Horizontal Movement
        if (keys.right) { this.vx = this.speed; this.facingRight = true; }
        else if (keys.left) { this.vx = -this.speed; this.facingRight = false; }
        else { this.vx *= 0.8; } // Friction

        this.x += this.vx;

        // Gravity
        this.vy += 0.5;
        this.y += this.vy;

        // Floor Collision (Simple)
        if (this.y + this.h > 400) {
            this.y = 400 - this.h;
            this.vy = 0;
            this.grounded = true;
        } else {
            this.grounded = false;
        }

        // Platform Collisions
        platforms.forEach(p => {
            if (this.x < p.x + p.w && this.x + this.w > p.x &&
                this.y + this.h > p.y && this.y + this.h < p.y + p.h + 10 &&
                this.vy >= 0) {
                this.y = p.y - this.h;
                this.vy = 0;
                this.grounded = true;
            }
        });

        // Jump
        if (keys.up && this.grounded) {
            this.vy = this.jumpPower;
            this.grounded = false;
            playSound('jump');
        }

        // Bounds
        if (this.x < 0) this.x = 0;
    }

    draw() {
        // Draw Arka (Pixel Art Style via Rects)
        ctx.fillStyle = this.color;
        // Body
        ctx.fillRect(this.x - cameraX, this.y, this.w, this.h);
        // Head
        ctx.fillStyle = "#F5D0A9"; // Skin
        ctx.fillRect(this.x + 2 - cameraX, this.y - 12, 16, 12);
        // Headband/Hat (Ethnic)
        ctx.fillStyle = "#D32F2F";
        ctx.fillRect(this.x + 2 - cameraX, this.y - 12, 16, 4);
        // Bag (Scrolls)
        ctx.fillStyle = "#8D6E63";
        ctx.fillRect(this.x + 8 - cameraX, this.y + 10, 14, 14);
        
        // Legs animation
        if(Math.abs(this.vx) > 0.5) {
             const offset = Math.sin(frame * 0.2) * 5;
             ctx.fillStyle = "#3E2723"; // Dark pants
             ctx.fillRect(this.x - cameraX, this.y + 20, 8, 12 + offset);
             ctx.fillRect(this.x + 12 - cameraX, this.y + 20, 8, 12 - offset);
        } else {
             ctx.fillStyle = "#3E2723";
             ctx.fillRect(this.x - cameraX, this.y + 20, 20, 12);
        }
    }
}

let player = new Player();
let platforms = [];
let particles = [];
let gate = null;
let scrolls = [];
let collectedScrolls = 0;

function initLevel(levelIdx) {
    player = new Player();
    cameraX = 0;
    collectedScrolls = 0;
    keys.right = false;
    keys.left = false;
    
    // Procedural Generation of Platforms
    platforms = [];
    let curX = 0;
    const levelLength = 2000;
    const levelData = LEVELS[levelIdx];

    // Ground segments
    for(let i=0; i<levelLength; i+=100) {
        if(Math.random() > 0.15) { // 15% chance of gap
            platforms.push({x: i, y: 400, w: 100, h: 50, type: 'ground'});
        }
    }

    // High Platforms
    for(let i=300; i<levelLength - 400; i+=250) {
        let h = 250 + Math.random() * 100;
        platforms.push({x: i, y: h, w: 80, h: 20, type: 'plat'});
    }

    // Gate at end
    gate = { x: levelLength - 300, y: 250, w: 60, h: 150, active: true };

    // Collectibles (Scrolls)
    scrolls = [];
    for(let i=0; i<3; i++) {
        scrolls.push({
            x: 400 + (i * 400) + Math.random()*100,
            y: 300 - Math.random()*100,
            w: 20, h: 20,
            active: true
        });
    }

    // UI Updates
    document.getElementById('score-display').innerText = `LEVEL ${levelIdx+1}: ${levelData.name}`;
    updateLives();
}

function updateLives() {
    let s = "";
    for(let i=0; i<lives; i++) s += "❤";
    document.getElementById('lives-display').innerText = s;
}

function startGame() {
    document.getElementById('start-screen').classList.add('hidden');
    gameState = 'PLAYING';
    initLevel(currentLevelIdx);
    gameLoop();
}

// Particle System for Effects
function createParticles(x, y, color) {
    for(let i=0; i<20; i++) {
        particles.push({
            x: x, y: y,
            vx: (Math.random() - 0.5) * 10,
            vy: (Math.random() - 0.5) * 10,
            life: 30,
            color: color
        });
    }
}

function updateParticles() {
    for(let i=particles.length-1; i>=0; i--) {
        let p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.life--;
        if(p.life <= 0) particles.splice(i, 1);
    }
}

function drawParticles() {
    particles.forEach(p => {
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x - cameraX, p.y, 4, 4);
    });
}

// Main Loop
function gameLoop() {
    if(gameState === 'PLAYING') {
        frame++;
        
        // Update
        player.update();
        
        // Camera Follow
        if(player.x > cameraX + 300) {
            cameraX = player.x - 300;
        }

        // Collectibles check
        scrolls.forEach(s => {
            if(s.active && 
               player.x < s.x + s.w && player.x + player.w > s.x &&
               player.y < s.y + s.h && player.y + player.h > s.y) {
                s.active = false;
                collectedScrolls++;
                playSound('collect');
                createParticles(s.x, s.y, "#FFD700");
            }
        });

        // Gate Interaction
        if(gate.active && player.x + player.w > gate.x && player.x < gate.x + gate.w) {
            // Check if close enough
             if(Math.abs(player.x - gate.x) < 50) {
                 gameState = 'PUZZLE';
                 startPuzzle();
             }
        }
        
        // Pit Death
        if(player.y > 600) {
            lives--;
            updateLives();
            playSound('error');
            if(lives <= 0) {
                gameState = 'GAMEOVER';
                document.getElementById('gameover-screen').classList.remove('hidden');
            } else {
                initLevel(currentLevelIdx); // Reset level
            }
        }

        // Draw
        drawGame();

    } else if (gameState === 'PUZZLE') {
        drawGame(); // Keep game visible in background
        // UI is handled by HTML overlay
    }
    
    if(gameState !== 'GAMEOVER') requestAnimationFrame(gameLoop);
}

function drawGame() {
    const levelData = LEVELS[currentLevelIdx];
    
    // Background (Parallax simulation via simple rects)
    ctx.fillStyle = levelData.bg;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Distant scenery (Mountains/Trees)
    ctx.fillStyle = levelData.fg;
    for(let i=0; i<10; i++) {
        let pX = (i * 200) - (cameraX * 0.2); // Slower movement
        ctx.fillRect(pX % (canvas.width + 200) - 200, 200, 100, 300);
    }

    // Platforms
    platforms.forEach(p => {
        ctx.fillStyle = levelData.accent; // Top grass/detail
        ctx.fillRect(p.x - cameraX, p.y, p.w, 10);
        ctx.fillStyle = levelData.bg; // Darker body
        ctx.filter = "brightness(50%)";
        ctx.fillRect(p.x - cameraX, p.y + 10, p.w, p.h - 10);
        ctx.filter = "none";
    });

    // Gate
    if(gate.active) {
        ctx.fillStyle = "#333";
        ctx.fillRect(gate.x - cameraX, gate.y, gate.w, gate.h);
        ctx.fillStyle = "#FFD700";
        ctx.font = "30px Arial";
        ctx.fillText("⛩️", gate.x - cameraX + 10, gate.y + 80);
        // Gate Aura
        ctx.strokeStyle = `rgba(255, 215, 0, ${Math.abs(Math.sin(frame*0.1))})`;
        ctx.lineWidth = 5;
        ctx.strokeRect(gate.x - cameraX, gate.y, gate.w, gate.h);
    }

    // Collectibles (Scrolls)
    scrolls.forEach(s => {
        if(s.active) {
            let floatY = Math.sin(frame * 0.1) * 5;
            ctx.fillStyle = "#FFF";
            ctx.fillRect(s.x - cameraX, s.y + floatY, s.w, s.h);
            ctx.strokeStyle = "#8B4513";
            ctx.lineWidth = 2;
            ctx.strokeRect(s.x - cameraX, s.y + floatY, s.w, s.h);
            ctx.fillStyle = "#FF0000"; // Ribbon
            ctx.fillRect(s.x + 8 - cameraX, s.y + floatY, 4, 20);
        }
    });

    player.draw();
    updateParticles();
    drawParticles();
}

/**
 * PUZZLE LOGIC
 */
let currentPuzzleAnswer = [];
let userPuzzleInput = [];

function startPuzzle() {
    const data = LEVELS[currentLevelIdx].word;
    const ui = document.getElementById('puzzle-interface');
    
    document.getElementById('puzzle-question').innerText = data.text;
    document.getElementById('puzzle-feedback').innerText = "";
    ui.style.display = 'flex';
    
    currentPuzzleAnswer = data.script;
    userPuzzleInput = [];
    
    // Setup Slots (Empty boxes)
    const slotsDiv = document.getElementById('puzzle-slots');
    slotsDiv.innerHTML = '';
    for(let i=0; i<currentPuzzleAnswer.length; i++) {
        let d = document.createElement('div');
        d.className = `slot ${LEVELS[currentLevelIdx].fontClass}`;
        d.id = `slot-${i}`;
        slotsDiv.appendChild(d);
    }

    // Setup Options (Shuffled)
    const optionsDiv = document.getElementById('puzzle-options');
    optionsDiv.innerHTML = '';
    
    // Create options with Romanized hint
    let options = data.script.map((s, i) => ({ char: s, hint: data.roman[i] }));
    // Add a distractor/decoy if possible, or just shuffle
    options.sort(() => Math.random() - 0.5);

    options.forEach(opt => {
        let btn = document.createElement('div');
        btn.className = `aksara-btn ${LEVELS[currentLevelIdx].fontClass}`;
        btn.innerHTML = `${opt.char} <span>(${opt.hint})</span>`;
        btn.onclick = () => addToSlot(opt.char);
        optionsDiv.appendChild(btn);
    });
    
    // Stop player
    keys.right = false;
    keys.left = false;
}

function addToSlot(char) {
    if(userPuzzleInput.length < currentPuzzleAnswer.length) {
        userPuzzleInput.push(char);
        updateSlots();
    }
}

function updateSlots() {
    for(let i=0; i<currentPuzzleAnswer.length; i++) {
        let el = document.getElementById(`slot-${i}`);
        el.innerText = userPuzzleInput[i] || "";
    }
    document.getElementById('puzzle-feedback').innerText = "";
}

function checkPuzzle() {
    let isCorrect = true;
    if(userPuzzleInput.length !== currentPuzzleAnswer.length) isCorrect = false;
    else {
        for(let i=0; i<userPuzzleInput.length; i++) {
            if(userPuzzleInput[i] !== currentPuzzleAnswer[i]) isCorrect = false;
        }
    }

    if(isCorrect) {
        playSound('gate_open');
        document.getElementById('puzzle-interface').style.display = 'none';
        gate.active = false;
        createParticles(gate.x, gate.y, "#FFFFFF");
        
        // Show Level Complete after a moment
        setTimeout(() => {
            gameState = 'TRANSITION';
            if(currentLevelIdx < LEVELS.length - 1) {
                document.getElementById('level-screen').classList.remove('hidden');
                document.getElementById('level-title').innerText = `LEVEL ${currentLevelIdx+1} SELESAI`;
            } else {
                showVictory();
            }
        }, 1000);
    } else {
        playSound('error');
        lives--;
        updateLives();
        document.getElementById('puzzle-feedback').innerText = "Susunan salah! Obor meredup.";
        userPuzzleInput = [];
        updateSlots();
        if(lives <= 0) {
            document.getElementById('puzzle-interface').style.display = 'none';
            document.getElementById('gameover-screen').classList.remove('hidden');
            gameState = 'GAMEOVER';
        }
    }
}

function nextLevel() {
    currentLevelIdx++;
    document.getElementById('level-screen').classList.add('hidden');
    initLevel(currentLevelIdx);
    gameState = 'PLAYING';
}

function showVictory() {
    gameState = 'VICTORY';
    document.getElementById('victory-screen').classList.remove('hidden');
    const lib = document.getElementById('library-content');
    lib.innerHTML = '';
    
    DICTIONARY.forEach(item => {
        let card = document.createElement('div');
        card.className = 'lib-card';
        card.innerHTML = `
            <div style="color:var(--ui-gold); font-size:12px;">${item.region}</div>
            <h3 style="margin:5px 0;">${item.word}</h3>
            <div style="font-size:24px; margin:5px 0;">${item.script}</div>
            <div style="font-style:italic;">"${item.mean}"</div>
            <p style="font-size:10px; color:#ccc;">${item.desc}</p>
        `;
        lib.appendChild(card);
    });
}

// Initial Render for Menu Bg
ctx.fillStyle = "#222";
ctx.fillRect(0, 0, canvas.width, canvas.height);

</script>
</body>
</html>